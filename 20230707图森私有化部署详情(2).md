 #  20230707图森私有化部署详情



## Release Notes

- 修改网关侧 Hostname 为云端车辆名称；
- 网关测 CAN 日志在网络切换成厂房网络时可以自动回传 CAN 日志文件到云端；
- 云端支持远程配置 SIM 卡网络；
- 云端 OSS 存储的 CAN 文件名称改为 CAN 原始文件名称；

## 服务变更列表

```html
ota-file：main-9ded05b4-5766
ota-management-ui: main-6e40ef07-6544
ota-property: master-19ab0229-7594
iot-device-manager: feature-mongo-b16abcc2-7598
http-proxy-for-gateway: main-510792e8-5018
```

## 配置文件修改

### configmap 配置修改

* iot-device-manager.yaml

**新增**

```yaml
#无缩进
service:
  #缩进2个英文空格
  file_upload_enabled: True
#无缩进
http:
  #缩进2个英文空格
  default_can_path: "/data/log/can/"
  can_log_format: ^can.log.\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2}.zip$
  base_server_url: "http://ota-gateway.dev"
  get_device_path_file: '/property/device/%s/file?path=%s&isRefresh=true&logType=CAN 日志'
  get_file_upload_tasks: '/file/file-upload-tasks?vin=%s&originalName=%s&logType=CAN 日志&status=success,fail'
  create_file_upload_tasks: '/property/%s/file-upload-tasks'

```

* http-proxy-for-gateway.yaml

**修改**

```yaml
#无缩进
service:
  #缩进2个英文空格
  proxy:
    #缩进4个英文空格
    timeout: 100
```

* apisix



### nacos修改

* base.yaml

**新增**

```yaml
#无缩进
spring:
#缩进2个英文空格
  kafka:
  #缩进4个英文空格
    consumer:
    #缩进6个英文空格
      property:
      #缩进8个英文空格
        update-hostname: update-hostname
```

* file-prod

**新增**

```yaml
#无缩进
minio:
#缩进2个英文空格
  readOnly:
    #缩进4个英文空格
    accessKeyId: **
    accessKeySecret: **
    out-endpoint: https://minio-api.simple.cloud/ #外网访问minio地址，需要根据实际修改
```



## 测试用例

| 用例名称                                          | 测试步骤                                                     | 期望结果                                                     |
| ------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 测试hostname修改                                  | 1、登陆云端，在“资产库”中修改车辆名称为“bj-DEV14”，车辆VIN码和车辆名称不同；     <br />2、设备上电；     <br />3、在网关运维界面，搜索“bj-DEV14”车辆，点击右侧“开启远程”按钮；     <br />4、远程开启成功后，复制ssh连接地址进行登陆；     <br />5、登陆成功后，查看hostname；     <br />6、手动或者远程重启设备；    <br /> 7、使用网线直连设备，ssh root@192.168.30.1登陆设备；    <br /> 8、登陆成功后，查看hostname； | 1、步骤5，设备hostname显示为“bj-DEV14”；     <br />2、步骤8、设备hostname显示为“root@bj-DEV14”； |
| 网络切换到厂房网络时自动创建升级任务              | 1、远程登陆设备，在  CAN 目录下每一路目录中创建24个tar文件；     <br />2、使用命令创建厂房网络文件；     <br />3、查看云端同步任务； | 1、步骤3在云端可以看到创建的CAN日志上传任务；                |
| 只支持上传tar文件                                 | 1、远程登陆设备，在  CAN 目录下每一路目录中创建24个tar文件，修改其中一个文件为txt格式；     <br />2、使用命令创建厂房网络文件；     <br />3、查看云端同步任务； | 1、步骤3在云端可以看到CAN日志上传任务，但是.txt文件没有创建上传任务； |
| 上传过程中，网络切换移动网络                      | 1、远程登陆设备，在  CAN 目录下每一路目录中创建24个tar文件；     <br />2、使用命令创建厂房网络文件；     <br />3、查看云端同步任务；     <br />4、使用命令删除厂房网络文件；     <br />5、查看云端同步任务 | 1、步骤3可以看到创建的CAN日志上传任务；<br />2、步骤5之后，未上传的CAN日志没有创建上传任务； |
| 多台设备上传测试                                  | 1、远程登陆多台设备，在  CAN 目录下每一路目录中创建24个tar文件，修改其中一个文件为txt格式；     <br />2、使用命令创建厂房网络文件；    <br />3、查看云端同步任务； | 1、所有设备均可以上传CAN日志文件。                           |
| 远程配置 SIM 卡网络                               | 1、登陆云平台，点击“运维中心”->“网关运维”；<br />2、选择测试的网关设备，点击“调试网关”；<br />3、在跳转的页面中，点击“系统设置”->“5G设置”；<br />4、在“5G设置”页面中切换“使用卡”，点击应用；<br /> | 1、步骤4可以成功。                                           |
| 云端 OSS 存储的 CAN 文件名称改为 CAN 原始文件名称 | 1、远程登陆设备，在  CAN 目录下每一路目录中创建24个tar文件；     <br />2、使用命令创建厂房网络文件；     <br />3、查看云端同步任务；<br />4、上传任务完成之后，使用阿里云账号登陆OSS管理界面，查看CAN日志文件名称； | 1、步骤4上传的文件名称和步骤3显示的文件名称相同。            |
