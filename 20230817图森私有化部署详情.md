 #  20230817图森私有化部署详情



## Release Notes

**图森需求**：

- 支持车辆 VIN 码维度管理网关日志；
- 修复mqtt ClientID重复的问题；

**云驰功能优化**：

* 新增车辆界面增加部分新字段；
* 车辆列表增加新的表头、统计信息；
* 车辆详情中增加上下线记录、版本更新记录；
* 网关运维列表增加车辆信息；
* 增加重置OTA功能，解决VIN修改不能OTA的问题；
* 网关配置支持多型号设备；
* 默认证书导入配置页面

## 服务变更列表

```html
ota-file：
ota-management-ui：
ota-personnel：
ota-property:
reverse-proxy:
ota-camunda:
ota-director:
ota-image:
gateway:
iot-device-manager:
http-proxy-for-gateway:
```

## 配置文件修改

### 1、configmap 配置修改

* iot-device-manager.yaml

**新增**

```yaml
#无缩进
service:
  #缩进2个英文空格
  file_upload_enabled: True
#无缩进
http:
  #缩进2个英文空格
  default_can_path: "/data/log/can/"
  can_log_format: ^can.log.\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2}.zip$
  base_server_url: "http://ota-gateway.dev"
  get_device_path_file: '/property/device/%s/file?path=%s&isRefresh=true&logType=CAN 日志'
  get_file_upload_tasks: '/file/file-upload-tasks?vin=%s&originalName=%s&logType=CAN 日志&status=success,fail'
  create_file_upload_tasks: '/property/%s/file-upload-tasks'

```

* http-proxy-for-gateway.yaml

**修改**

```yaml
#无缩进
service:
  #缩进2个英文空格
  proxy:
    #缩进4个英文空格
    timeout: 100
```

* apisix

**增加** **Topic** 

1. kafka Topic
2. Emqx 添加订阅系统Topci的权限
   1. $SYS/brokers/+/clients/+/connected
   2. $SYS/brokers/+/clients/+/disconnected





### 2、nacos修改

* base.yaml

**新增**

```yaml
#无缩进
spring:
#缩进2个英文空格
  kafka:
  #缩进4个英文空格
    consumer:
    #缩进6个英文空格
      property:
      #缩进8个英文空格
        update-hostname: update-hostname
```

* file-prod

**新增**

```yaml
#无缩进
minio:
#缩进2个英文空格
  readOnly:
    #缩进4个英文空格
    accessKeyId: **
    accessKeySecret: **
    out-endpoint: https://minio-api.simple.cloud/ #外网访问minio地址，需要根据实际修改
```



## 测试用例

**测试前，网关版本需要升级到最新版本，即：0804之后版本**

| 用例名称                   | 测试步骤                                                     | 期望结果                                                     |
| -------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 网关日志支持多维度管理     | 1、在车辆管理中，选择某辆车，填写车辆VIN码、车牌号；<br />2、在“运维配置”-》“日志采集”-》“日志管理配置”中选择车辆VIN码；<br />3、在网关日志中选择步骤1中的车辆，随机挑选一个文件进行上传；<br />4、在“运维配置”-》“日志采集”-》“日志管理配置”中选择车牌号；<br />5、在网关日志中选择步骤1中的车辆，随机挑选一个文件进行上传；<br />6、在“运维配置”-》“日志采集”-》“日志管理配置”中选择主ECU序列号；<br />7、在网关日志中选择步骤1中的车辆，随机挑选一个文件进行上传；<br /> | 1、步骤3，在阿里云oss中查看，可以看到:VIN/SN/文件名；     <br />2、步骤5，在阿里云oss中查看，可以看到:车牌号/SN/文件名；  <br />3、步骤7、在阿里云oss中查看，可以看到:SN/文件名； |
| CAN日志自动上传            | 1、在“运维配置”-》“日志采集”-》“日志管理配置”中选择车辆VIN码，在分类配置中将CAN日志启用自动上传到云端功能<br />2、ssh登陆某辆车辆，创建厂房网络标识文件；<br />3、查看云端是否有自动创建任务；<br />4、查看阿里云oss端文件列表； | 1、步骤3可以看到自动创建的CAN日志上传任务；<br />2、步骤4可以在oss中看到:VIN/SN/文件名； |
| 新增车辆界面增加部分新字段 | 测试使用默认证书<br />测试修改车辆VIN码<br />测修改网关SN    | 1、步骤3在云端可以看到创建的CAN日志上传任务；                |
| 测试上下线统计             | 1、选择现场一台测试设备，对设备手动执行多次上线下线操作<br />2、在车辆管理中，查看车辆详情界面；<br />3、点击车辆状态右侧“历史记录”按钮 | 1、步骤3中弹出界面可以显示车辆的历史上下线记录；             |
| 重置 OTA                   | 1、在云端选择一台有升级历史的车辆；<br />2、在网关运维界面中对该车辆执行“重置OTA”操作；<br />3、在云端新建升级任务，查看升级任务中的当前版本号； | 1、步骤3中的当前版本号为1；                                  |
| 远程登陆支持多型号设备     | 1、在“运维配置”-》“远程调试”-》“设备配置”中添加设备范围，选择L3000+所有车队；<br />2、在网关运维中选择一台在线设备，开启远程； | 1、步骤2可以成功开启远程，并登陆成功；                       |
| 默认证书导入               | 1、在“系统配置”-》“证书管理”-》“网关默认证书”中添加图森自己的网关证书；<br />2、在车辆管理中，选择一台在线的设备，对其进行编辑，选择证书为默认证书；<br /> | 1、步骤2编辑可以完成，<br />2、编辑完成之后，设备可以正常工作，显示在线； |
