 #  20230418图森私有化部署详情



## Release Notes

- 修复网关 SSH 指纹变化导致云端无法创建 SSH 连接的问题
- 修复制作整车升级包页面中查询接口存在 sql 注入的问题
- 更新调试网关页面版本到最新版本



## 服务变更列表

```html
ota-file
ota-management-ui
ota-personnel
ota-property
ota-camunda
ota-director
ota-image
reverse-proxy
```



## 配置更改

1. ConfigMaps 更改

修改项：

```yaml
#无缩进
proxy:
  #缩进2个英文空格
  timeout:30 #9改成30
```

2. apisix

![img](./img/ota/lQDPJw5Uv_Fhi5LNAtnNBiGwaUXePZ7knH8ENUF-DwCyAQ_1569_729.jpg)

![img](./img/ota/lQLPJw0xtiMNi5LNA27NBUCwfyxGl_ZQRXwENUF-D4CFAA_1344_878.png)

这页无法修改 upstream 配置，仅用于搜索 upstream 名称，进入 upstream 菜单后查找 upstream名称再修改。

![img](./img/ota/lQDPJxRDmx4n65LNAi3NBQmwd7FjqTmdsk0ENUF-EcAqAA_1289_557.jpg)

![img](./img/ota/lQDPJyCy1l7eq5LNBMvNBQWwiJg8GQ6UWBwENUF-DwCyAA_1285_1227.jpg)

在这页修改完点 “Next” “Submit” 即可。



## 冒烟测试

| 用例名称                      | 测试步骤                                                     | 期望结果                                                     |
| ----------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| SSH  登录新设备               | 1、使用云驰智云平台对测试网关进行升级；     <br />2、升级完成后，在“运维中心”->“网关运维”界面输入测试网关sn并点击查找按钮；     <br />3、在查询出来的网关中点击“开启远程”按钮；    <br />4、开启成功后，查看远程连接地址，复制对应的ssh地址；     <br />5、在shell终端中输入ssh登录地址，登录测试网关 | 1、步骤5中，登录网关可以成功。                               |
| 多次 SSH  登录设备            | 1、在云驰智云平台添加两个L3000设备：设备1和设备2；     <br />2、在“运维中心”->“网关运维”界面输入设备1 sn 并点击查找按钮；     <br />3、在查询出来的网关中点击“开启远程”按钮；     <br />4、开启成功后，查看远程连接地址，复制对应的ssh地址，在shell终端中进行远程登录；     <br />5、在“运维中心”->“网关运维”界面对设备1执行“关闭远程”操作；     <br />6、重复步骤2~5，重复10次；     <br />7、在“运维中心”->“网关运维”界面输入设备2 sn 并点击查找按钮；     <br />8、在查询出来的网关中点击“开启远程”按钮；     <br />9、开启成功后，查看远程连接地址，复制对应的ssh地址，在shell终端中进行远程登录； | 1、步骤9中，设备2可以登录成功。     <br />2、云端 SSH 服务中，仅保存设备2的一个know_hosts； |
| 使用过程中切换DNS 并开启  SSH | 1、使用网络直连网关，ssh登录网关设备，保证网关设备可以上网；     <br />2、登录设备之后，手动修改修改DNS Server，均修改成不可以上网的DNS Server；     <br />3、等待一分钟之后，在云端平台开启SSH；     <br />4、继续手动修改 DNS Server，修改成可以上网的DNS Server；     <br />5、等待一分钟之后，在云端平台开启SSH； | 1、步骤3中，网关无法访问ssh服务，设备离线，无法开启SSH；     <br />2、步骤5中，网关可以访问ssh服务，设备在线，正常开启SSH； |
| 数据库注入                    | 1、借助apifox工具测试平台中使用的接口；     <br />2、在apifox中添加项目组，加入项目组后点击左侧”项目管理“菜单；     <br />3、在接口中找到”GET  查询snapshot列表“接口-/image/snapshot/querySnapshotList，在head中添加token信息；     <br />4、在Query参数中，修改ordBy中的值为”created_time“，点击”发送“，查看响应结果；     <br />5、在Query参数中，修改ordBy中的值为”1111“，点击”发送“，查看响应结果；    <br />6、在Query参数中，修改ordBy中的值为”created_time;delete ir_snapshot where id =10;  select * from ir_snapshot“，点击”发送“，查看响应结果；     <br />7、在Query参数中，修改ordBy中的值为”1“或者”true“或者”false“，点击”发送“，查看响应结果；    <br / <br />8、在Query参数中，修改ordBy中的值为”1;1=1“或者”true;1=1“或者”false;1=1“或者“true'  1=1”或者“ture; AND 1=1”，点击”发送“，查看响应结果；<br /><br />说明：如果用户使用步骤1、2、3不方便，可以采用浏览器登录的方式进行验证，对应如下步骤：<br /><br />1. 登录云驰智云平台，点击“OTA 中心” -> “制作整车升级包”菜单；<br />2. 在制作整车升级包页面中，点击F12打开调试窗口并打开“网络”界面，点击页面中的“搜索”按钮，点击调试窗口中名称为“querySnapshotList？****”的链接；<br />3.复制“标头”页中的“请求URL”，如：https://tusimple.inchtek.cloud/api/ota/image/snapshot/querySnapshotList?pageNum=1&pageSize=20&orderBy=updated_time%20desc&flag=0 （此处需要根据实际显示的url复制），将该URL复制到浏览器中，修改ordBy=后面的参数；<br />后续的操作同上述4、5、6、7、8. | 1、步骤4中，可以返回所有的数据；     <br />2、步骤5中，返回错误500，且不会暴露数据库结构；     <br />3、步骤6中，返回错误500，且不会暴露数据库结构；     <br />4、步骤8中，返回错误500，且不互暴露数据库结果； |
| 浏览网关配置                  | 1、登录云驰智云平台，在”网关运维”中选择需要访问的网关，点击“调试网关”按钮；     <br />2、在跳转页面中，分别点击左侧菜单及子菜单项，获取对应的网关信息；     <br />3、使用网线直连网关，登录 http://192.168.30.1:5000/ 页面，分别点击步骤2中的点击的页面，两者进行比较； | 1、步骤2、3中相同页面展示的信息完全相同；                    |
| 修改网关配置                  | 1、登录云驰智云平台，在”网关运维”中选择需要访问的网关，点击“调试网关”按钮；     <br />2、在跳转页面中，分别点击左侧菜单及子菜单项，设置对应的网关信息，包括系统、安全、网络方面的设置；     <br />3、使用网线直连网关，登录 http://192.168.30.1:5000/  页面，分别点击步骤2中的点击的页面，查看步骤2中下发的配置是否生效；          <br />说明：云端嵌入本地WEB界面不支持大文件的传输，因此关于远程升级和配置导出及导入的操作在云端不支持； | 1、步骤2中可以配置成功；     2、步骤3中可以查看到配置已经生效； |

